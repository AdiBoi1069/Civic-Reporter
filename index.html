<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Civic Reporter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Ensures the map takes up the full screen height minus the nav bar */
        #map { height: calc(100vh - 64px); }
        .leaflet-container { font-family: 'Inter', sans-serif; }
        /* Simple spinner animation */
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 font-sans flex flex-col h-screen">

    <!-- Main Content Area -->
    <main id="content" class="flex-1 overflow-y-auto">

        <!-- Screen 1: Report an Issue (Visible by default) -->
        <div id="report-screen">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Report an Issue</h1>
                    <p class="text-gray-500 mt-1">Pimpri-Chinchwad Civic Reporter</p>
                </div>

                <!-- Location Info Bar -->
                <div id="location-info" class="flex items-center justify-center bg-blue-50 p-3 rounded-lg mb-6 border border-blue-200">
                    <i class="fas fa-location-crosshairs text-blue-500"></i>
                    <span id="location-text" class="ml-2 text-sm text-blue-700">Fetching your location...</span>
                </div>

                <!-- Report Submission Form -->
                <form id="report-form" class="space-y-4">
                    <div>
                        <label for="issue-type" class="block text-sm font-medium text-gray-700">Type of Issue</label>
                        <select id="issue-type" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Pothole</option>
                            <option>Overflowing Trash Bin</option>
                            <option>Streetlight Outage</option>
                            <option>Broken Sidewalk</option>
                            <option>Water Leak</option>
                            <option>Stray Animals</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Add Photo</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer">
                            <div id="photo-preview-container" class="space-y-1 text-center hidden">
                                <img id="photo-preview" class="mx-auto h-24 w-auto rounded-md" src="" alt="Photo preview" />
                                <p class="text-xs text-gray-500">Photo attached. Click to change.</p>
                            </div>
                            <div id="upload-prompt" class="space-y-1 text-center">
                                <i class="fas fa-camera fa-2x mx-auto text-gray-400"></i>
                                <p class="text-sm text-gray-600">Click to capture or upload</p>
                            </div>
                        </div>
                        <!-- The `capture="environment"` attribute is the key to telling mobile browsers
                             to open the rear-facing camera directly. On desktop, it falls back to a file picker. -->
                        <input id="photo-upload" type="file" accept="image/*" capture="environment" class="sr-only">
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                        <textarea id="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Let Gemini describe it from the photo, or add your own details here."></textarea>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span id="submit-text">Submit Report</span>
                        <div id="submit-spinner" class="spinner h-5 w-5 rounded-full border-2 border-white border-t-transparent hidden"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Screen 2: Map View (Hidden by default) -->
        <div id="map-screen" class="hidden">
            <div id="map"></div>
        </div>
    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="bg-white border-t flex justify-around">
        <button id="nav-report" class="flex-1 text-center py-3 text-indigo-600 border-t-2 border-indigo-600">
            <i class="fas fa-plus-circle fa-lg"></i>
            <span class="block text-xs">Report</span>
        </button>
        <button id="nav-map" class="flex-1 text-center py-3 text-gray-500">
            <i class="fas fa-map-marked-alt fa-lg"></i>
            <span class="block text-xs">View Map</span>
        </button>
    </nav>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = 'http://localhost:8080'; // Your backend server URL

        // --- STATE MANAGEMENT ---
        let userLocation = { lat: 18.6298, lng: 73.7997 }; // Default: Pimpri-Chinchwad
        let photoBase64 = null;

        // --- DOM ELEMENTS ---
        const reportScreen = document.getElementById('report-screen');
        const mapScreen = document.getElementById('map-screen');
        const navReport = document.getElementById('nav-report');
        const navMap = document.getElementById('nav-map');
        const locationText = document.getElementById('location-text');
        const photoUpload = document.getElementById('photo-upload');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const photoPreview = document.getElementById('photo-preview');
        const uploadPrompt = document.getElementById('upload-prompt');
        const form = document.getElementById('report-form');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const descriptionEl = document.getElementById('description');

        // --- MAP INITIALIZATION ---
        let map;
        let isMapInitialized = false;
        function initializeMap() {
            if (!isMapInitialized && mapScreen && !mapScreen.classList.contains('hidden')) {
                map = L.map('map').setView([userLocation.lat, userLocation.lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                isMapInitialized = true;
                fetchAndDisplayReports();
            }
        }

        // --- FUNCTIONS ---

        // Navigation logic to switch between screens
        function showScreen(screen) {
            const isReportScreen = screen === 'report';
            reportScreen.classList.toggle('hidden', !isReportScreen);
            mapScreen.classList.toggle('hidden', isReportScreen);
            navReport.classList.toggle('text-indigo-600', isReportScreen);
            navReport.classList.toggle('border-indigo-600', isReportScreen);
            navReport.classList.toggle('text-gray-500', !isReportScreen);
            navMap.classList.toggle('text-indigo-600', !isReportScreen);
            navMap.classList.toggle('border-indigo-600', !isReportScreen);
            navMap.classList.toggle('text-gray-500', isReportScreen);
            
            if (!isReportScreen) initializeMap();
        }
        
        navReport.onclick = () => showScreen('report');
        navMap.onclick = () => showScreen('map');

        // Get user's GPS location
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    locationText.textContent = `Location captured successfully`;
                }, () => {
                    locationText.textContent = 'Location access denied. Using default.';
                }, { enableHighAccuracy: true });
            } else {
                locationText.textContent = "Geolocation is not supported by this browser.";
            }
        }

        // Handle photo selection and preview.
        // This makes the entire dashed box clickable, which in turn triggers the hidden file input.
        photoPreviewContainer.parentElement.onclick = () => photoUpload.click();
        photoUpload.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoBase64 = e.target.result.split(',')[1]; // Get just the Base64 part
                    photoPreview.src = e.target.result;
                    uploadPrompt.classList.add('hidden');
                    photoPreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        // Fetch existing reports and display them on the map
        async function fetchAndDisplayReports() {
            if (!isMapInitialized) return;
            try {
                const response = await fetch(`${API_BASE_URL}/reports`);
                const reports = await response.json();
                reports.forEach(report => {
                     L.marker([report.location.lat, report.location.lng])
                     .addTo(map)
                     .bindPopup(`<b>${report.issueType}</b><br>${report.description}<br>Status: ${report.status}`);
                });
            } catch (error) {
                console.error('Failed to fetch reports:', error);
            }
        }

        // Handle form submission
        form.onsubmit = async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            
            if (!photoBase64 && !descriptionEl.value.trim()) {
                alert('Please add a photo or a description.');
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                return;
            }

            const reportData = {
                issueType: document.getElementById('issue-type').value,
                description: descriptionEl.value,
                location: userLocation,
                photoBase64: photoBase64,
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reportData),
                });
                
                if (!response.ok) throw new Error('Server responded with an error');
                
                const result = await response.json();

                alert(`Report submitted successfully!\n\nGemini-generated description:\n"${result.description}"`);
                form.reset();
                photoBase64 = null;
                uploadPrompt.classList.remove('hidden');
                photoPreviewContainer.classList.add('hidden');
                
                // Switch to map view and show the new report
                showScreen('map');
                if (isMapInitialized) {
                     L.marker([userLocation.lat, userLocation.lng])
                         .addTo(map)
                         .bindPopup(`<b>${reportData.issueType}</b><br>${result.description}<br>Status: Submitted`)
                         .openPopup();
                    map.setView([userLocation.lat, userLocation.lng], 16);
                }

            } catch (error) {
                alert('Failed to submit report. Please check your connection and try again.');
                console.error('Submission error:', error);
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        };

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            getLocation();
        });

    </script>
</body>
</html>

